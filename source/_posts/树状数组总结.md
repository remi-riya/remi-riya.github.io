---
title: æ ‘çŠ¶æ•°ç»„æ€»ç»“
date: 2023-08-03T20:49:20+08:00
categories:
- ACM
tags:
- ç®—æ³•
- æ€»ç»“
---

æœ€è¿‘èŠ±äº†ä¸¤å¤©æ—¶é—´å­¦äº†ä¸‹æ ‘çŠ¶æ•°ç»„ï¼Œç„¶åæ„Ÿè§‰å ªæ¯”ç„å­¦ï¼Œæ•…å†™ç¯‡æ–‡ç« æ€»ç»“ä¸€ä¸‹ã€‚

---

æ ‘çŠ¶æ•°ç»„ï¼ˆ*binary indexed tree*ï¼‰ï¼Œä¹Ÿå«BITï¼Œåˆä»¥å…¶å‘æ˜äººåå­—è¢«ç§°ä¸ºFenwickæ ‘ã€‚æ ‘çŠ¶æ•°ç»„åˆ©ç”¨äºŒè¿›åˆ¶ä¸‹æ ‡æ¥ç»´æŠ¤åŒºé—´å’Œï¼Œèƒ½å¤Ÿåšåˆ°ä»¥$\log{n}$çš„å¤æ‚åº¦è¿›è¡Œå•ç‚¹ä¿®æ”¹å’ŒåŒºé—´æ±‚å’Œï¼ŒåŒæ—¶é…åˆå·®åˆ†æ•°ç»„ç­‰ç»“æ„ï¼Œè¿˜èƒ½åšåˆ°åŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢å’ŒåŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ç­‰åŠŸèƒ½ï¼Œç›¸æ¯”ä¸çº¿æ®µæ ‘æ¥è¯´æ›´ä¸ºç®€å•å’Œä¼˜é›…ã€‚

## åŸºæœ¬çŸ¥è¯†

æ ‘çŠ¶æ•°ç»„æœ€ä¸ºé‡è¦çš„ä¸€ä¸ªè®¾å®šå°±æ˜¯$lowbit$â€”â€”äºŒè¿›åˆ¶æœ€ä½ä½çš„1åŠå…¶åé¢çš„0æ‰€ç»„æˆçš„æ•°å­—ï¼Œç›¸æ¯”ä¸å‰ç¼€å’Œï¼Œæ ‘çŠ¶æ•°ç»„çš„æ¯ä¸€ä½ç»´æŠ¤çš„æ˜¯$\left(i-lowbit(i),i\right]$çš„åŒºé—´å’Œï¼Œæ¯”å¦‚6ï¼ŒäºŒè¿›åˆ¶ä¸º`110`ï¼Œé‚£ä¹ˆè¿™ä¸€ä½ç»´æŠ¤çš„å°±æ˜¯åŸæ•°ç»„6åˆ°4`100`çš„åŒºé—´å’Œï¼ˆä¸åŒ…å«4ï¼‰ã€‚

é‚£ä¹ˆè¦å¦‚ä½•è®¡ç®—ä¸€ä¸ªæ•°çš„$lowbit$å‘¢ï¼Ÿå¦‚æœç”¨ä¸€ä¸ª1ä½œä¸ºcheckæ¥åˆ¤æ–­æ¯ä¸€ä½æ˜¯å¦æ˜¯1ï¼Œé‚£ä¹ˆä»£ç å¤§æ¦‚é•¿è¿™æ ·ï¼š

```c++
for(int i = 0; i <= __lg(x); i++) {
    if(x & (1ll << i))
        return 1ll << i;
}
```

å¾ˆæ˜¾ç„¶ï¼Œä¸ä½†è¿è¡Œé€Ÿåº¦æ…¢ï¼Œè€Œä¸”ä¹Ÿä¸å¤Ÿç®€æ´ä¼˜é›…ï¼Œä¸ç¬¦åˆæ ‘çŠ¶æ•°ç»„çš„ç‰¹æ€§~~ä¸æ˜¯~~ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´ä¸ºç®€å•çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œå°±æœ‰äº†ä¸‹é¢è¿™ä¸ªå…¬å¼\[lowbit(x)=x\&-x\]ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è®¡ç®—æœºä¸­ï¼Œè´Ÿæ•°é‡‡ç”¨è¡¥ç å½¢å¼å­˜å‚¨ï¼Œè€Œè¡¥ç å°±æ˜¯**å–ååŠ 1**ï¼Œä¹Ÿå°±æ˜¯å°†æœ€ä½ä½1ä¹‹åçš„æ‰€æœ‰ä½å…¨éƒ¨å–åã€‚æ‰€ä»¥åªéœ€è¦ç”¨è¿™ä¸ªç®€å•çš„å…¬å¼å°±èƒ½è½»æ¾åœ°å¾—åˆ°ä¸€ä¸ªæ•°çš„$lowbit$ã€‚

## åŸºæœ¬æ“ä½œ

æœ€ç®€å•çš„æ ‘çŠ¶æ•°ç»„æ”¯æŒä¸¤ç§æ“ä½œï¼š**å•ç‚¹ä¿®æ”¹**å’Œ**åŒºé—´æŸ¥è¯¢**ã€‚ä¸¤ç§æ“ä½œéƒ½èƒ½å¤Ÿä»¥$\log{n}$çº§åˆ«çš„å¤æ‚åº¦å’Œ5è¡Œä»¥å†…çš„ä»£ç å®ç°ï¼Œååˆ†æ–¹ä¾¿ã€‚

é¦–å…ˆæ¥çœ‹ä¿®æ”¹æ“ä½œã€‚å¦‚æœæ˜¯æ™®é€šçš„æ•°ç»„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ç›´æ¥ä¿®æ”¹å¯¹åº”ä½ç½®çš„æ•°å­—å°±è¡Œäº†ã€‚ä½†æ ‘çŠ¶æ•°ç»„çš„æ¯ä¸€ä½ç»´æŠ¤çš„æ˜¯åŒºé—´å’Œï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶æˆ‘ä»¬åœ¨ä¿®æ”¹æ—¶åº”è¯¥æŠŠæ‰€æœ‰åŒ…å«è¯¥ä½ç½®çš„åŒºé—´éƒ½æ›´æ–°ä¸€éã€‚é‚£ä¹ˆå“ªäº›åŒºé—´ä¼šåŒ…å«éœ€è¦ä¿®æ”¹çš„ä½ç½®å‘¢ï¼Ÿå‡è®¾éœ€è¦ä¿®æ”¹çš„ä½ç½®ä¸º*i*ï¼Œé‚£ä¹ˆä¸€ä¸ªæ ‘çŠ¶æ•°ç»„æ‰€ç»´æŠ¤çš„åŒºé—´$\left(j-lowbit(j),j\right]$æƒ³è¦åŒ…å«*i*å°±éœ€è¦ä¿è¯$j-lowbit(j)<i$å¹¶ä¸”$j>=i$ï¼Œè¦ç›´æ¥æ‰¾å‡ºè¿™æ ·çš„åŒºé—´ä¼¼ä¹æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å…ˆæ¥ä¸¾ä¸ªç®€å•çš„ä¾‹å­ã€‚

å‡è®¾ç°åœ¨è¦ä¿®æ”¹çš„çš„ä½ç½®*i*ä¸º`1001 0110`ï¼ˆ150ï¼‰ï¼Œè®©æˆ‘ä»¬ä»`1001 0111`å¼€å§‹æšä¸¾ï¼Œæ˜¾ç„¶è¿™ä¸ªæ•°ä¸æ»¡è¶³$j-lowbit(j)<i$ï¼Œæ’é™¤ã€‚ç»§ç»­å¾€åæ‰¾ï¼Œä¸‹ä¸€ä¸ªæ•°æ˜¯`1001 1000`,å‡å»*lowbit*ä¸º`1001 0000`,æ˜¾ç„¶æ»¡è¶³è¦æ±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ‰¾åˆ°äº†â€”â€”`1001 1000`ã€‚ç»§ç»­å¾€ä¸‹æ‰¾ï¼Œæ˜¾ç„¶`1001 1000`æ— è®ºåé¢çš„3ä¸ª0é‚£ä¸ªå˜æˆ1éƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼ˆ`1001 1000`æœ¬èº«å°±å¤§äº*i*ï¼Œåé¢åŠ 1åå†å‡å»*lowbit*ä¸€å®šå¤§äº*i*ï¼‰ã€‚é‚£ä¹ˆå†ç»§ç»­å¾€åæ‰¾ï¼Œä¹Ÿå°±æ˜¯`1010 0000`ï¼Œæ˜¾ç„¶æ»¡è¶³ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°åé¢æ— è®ºå¦‚ä½•æ·»1éƒ½ä¸æ»¡è¶³â€¦â€¦ä»¥æ­¤ç±»æ¨ï¼Œå‡è®¾æ•°ç»„é•¿åº¦æ˜¯`1111 1111`ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„å…ƒç´ ä¸‹æ ‡å¦‚ä¸‹

```c++
1001 0110 //è‡ªå·±æ˜¾ç„¶å¯ä»¥ï¼Œä¸Šé¢å¿˜è®°å†™äº†â€¦â€¦
1001 1000
1010 0000
1100 0000
```

å‘ç°è§„å¾‹äº†å—ï¼Œæ•´ä¸ªä¸‹æ ‡å˜åŒ–çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªè¿›ä½çš„è¿‡ç¨‹ï¼Œæ¯æ¬¡åŠ çš„éƒ½æ˜¯*lowbit*ï¼Œç›´åˆ°åˆ°è¾¾æ•°ç»„è¾¹ç•Œã€‚ï¼ˆåº”è¯¥æœ‰æ›´ä¸ºå½¢è±¡çš„ç†è§£æ–¹å¼ï¼Œä½†æˆ‘æƒ³ä¸åˆ°â€¦â€¦çœ‹åˆ«äººå†™çš„ä¹Ÿä¸èƒ½ç†è§£ï¼Œå°±è´´ä¸ªé“¾æ¥å§â€¦â€¦[ç®—æ³•å­¦ä¹ ç¬”è®°(2) : æ ‘çŠ¶æ•°ç»„](https://zhuanlan.zhihu.com/p/93795692))
å›åˆ°æ­£é¢˜ï¼Œæ—¢ç„¶çŸ¥é“äº†æ€ä¹ˆæ‰¾åŒºé—´ï¼Œé‚£ä¹ˆä»£ç å°±å¥½å†™äº†ï¼š

```c++
void update(int x, int i) { //iä¸ºä½ç½®ï¼Œxä¸ºæ”¹å˜çš„é‡
    for(; i <= nmax; i += lowbit(i)) {
        tree[i] += x;
    }
}
```

ç›¸æ¯”äºä¿®æ”¹ï¼Œæ±‚å’Œå°±è¦ç®€å•å¾ˆå¤šã€‚åªéœ€è¦åˆ©ç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤çš„æ˜¯åŒºé—´å’Œè¿™ä¸€ç‰¹æ€§ï¼ŒæŠŠè¦æ±‚å’Œçš„åŒºé—´ä¸‹æ ‡ä»¥äºŒè¿›åˆ¶å±•å¼€å°±è¡Œäº†ã€‚æ¯”å¦‚æˆ‘ä»¬è¦æ±‚`1001 0110`çš„å‰ç¼€å’Œï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æŠŠå®ƒæ‹†æˆä»¥ä¸‹å‡ ä¸ªåŒºé—´ï¼š

```text
1001 0110 --- 1001 0100
1001 0100 --- 1001 0000
1001 0000 --- 1000 0000
1000 0000 --- 0000 0000
```

æ¯æ¬¡æ‹†åŒºé—´å°±æ˜¯å‡å»*lowbit*ï¼ŒåŒæ—¶è¦æ³¨æ„åˆ°ï¼Œç”±äºæ ‘çŠ¶æ•°ç»„ç»´æŠ¤çš„åŒºé—´æ˜¯å·¦å¼€å³é—­çš„ï¼Œæ‰€ä»¥ä»»ä½•åŒºé—´éƒ½æ— æ³•åŒ…å«0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡å¿…é¡»ä»1å¼€å§‹~~å½“ç„¶è¦æ˜¯ä¸å«Œéº»çƒ¦å¯ä»¥æ¯æ¬¡æ±‚å’Œéƒ½å•ç‹¬æŠŠ0åŠ ä¸Š~~æ±‚å’Œä»£ç å¦‚ä¸‹ï¼š

```c++
int sum(int i) {
    int res = 0;
    for(; i > 0; i -= lowbit(i)) {
        res += tree[i];
    }
    return res;
}
```

å¦‚æœæƒ³è¦æ±‚åŒºé—´$[l,r]$çš„å’Œåªéœ€è¦ç”¨$sum(r)-sum(l-1)$å°±è¡Œäº†ã€‚

é‚£ä¹ˆï¼Œè‡³æ­¤æ ‘çŠ¶æ•°ç»„çš„åŸºæœ¬æ“ä½œå°±ä»‹ç»å®Œäº†ã€‚

## ä¾‹é¢˜åŠæ‰©å±•åŠŸèƒ½

é¦–å…ˆæ˜¯æ´›è°·ä¸Šçš„ä¸¤é“æ¨¡æ¿é¢˜ï¼š
[P3374](https://www.luogu.com.cn/problem/P3374)
è¿™å°±æ˜¯æœ€ç®€å•çš„æ ‘çŠ¶æ•°ç»„ï¼Œå•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢ï¼Œå¤šæ¬¡è¯¢é—®ï¼Œç›´æ¥ä¸Šæ¨¡æ¿å°±è¡Œï¼š

```c++
#include <bits/stdc++.h>
#define lowbit(x) ((x) & -x)
using namespace std;
int tree[500010];
inline void update(int x, int i, int n)
{
    for (; i <= n; i += lowbit(i))
        tree[i] += x;
}
inline int sum(int r)
{
    int res = 0;
    for (; r > 0; r -= lowbit(r))
        res += tree[r];
    return res;
}
int main()
{
    ios::sync_with_stdio(false);
    cin.tie(0);
    int n, m;
    cin >> n >> m;
    for (int i = 1; i <= n; i++) {
        int a;
        cin >> a;
        update(a, i, n);
    }
    while (m--) {
        int op, x, y;
        cin >> op >> x >> y;
        if (op == 1)
            update(y, x, n);
        else
            cout << sum(y) - sum(x - 1) << '\n';
    }
}
```

ï¼ˆçªç„¶å‘ç°å¿˜è®°è¯´æ€ä¹ˆåˆå§‹åŒ–æ ‘çŠ¶æ•°ç»„äº†ï¼Œåªéœ€è¦åœ¨è¾“å…¥çš„æ—¶å€™*update*æ¯ä¸€ä½å°±è¡Œäº†ï¼Œå¯ä»¥ç†è§£ä¸ºåˆå§‹æœ‰ä¸€ä¸ªæ‰€æœ‰é¡¹éƒ½ä¸º0çš„æ•°ç»„ï¼Œæ¯æ¬¡è¾“å…¥éƒ½ç›¸å½“äºæ˜¯å•ç‚¹ä¿®æ”¹ï¼‰

---

å¦ä¸€é“æ¨¡æ¿é¢˜æ˜¯[P3368](https://www.luogu.com.cn/problem/P3368)

è¿™é¢˜å°±æ¶‰åŠåˆ°äº†æ ‘çŠ¶æ•°ç»„çš„å¦ä¸€ä¸ªç”¨æ³•ï¼ŒåŒºé—´ä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢ã€‚è¿™ä¹ä¸€çœ‹è·Ÿæ ‘çŠ¶æ•°ç»„çš„åŸºæœ¬æ“ä½œä¸èƒ½è¯´æ²¡æœ‰å…³ç³»ï¼Œåªèƒ½è¯´æ˜¯å—è¾•åŒ—è¾™ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¦ä¸€ç§æ•°æ®ç»“æ„äº†â€”â€”å·®åˆ†æ•°ç»„ã€‚

åœ¨å·®åˆ†æ•°ç»„é‡Œï¼Œå¯¹åŒºé—´çš„ä¿®æ”¹åªéœ€è¦ä¿®æ”¹åŒºé—´ä¸¤å¤´çš„æ•°å­—ï¼Œè€Œå•ç‚¹çš„æŸ¥è¯¢åˆ™æ˜¯æ±‚å‰ç¼€å’Œï¼Œè¿™æ ·å°±è·Ÿæ ‘çŠ¶æ•°ç»„çš„åŸºæœ¬æ“ä½œå¯¹åº”èµ·æ¥äº†ã€‚

```c++
 #include <bits/stdc++.h>
 #define lowbit(x) ((x) & -x)
 using namespace std;
 typedef long long ll;
 int tree[500010], a[500010];
 inline void update(int x, int i, int n)
 {
     for (; i <= n; i += lowbit(i))
         tree[i] += x;
 }
 inline int sum(int r)
 {
     int res = 0;
     for (; r > 0; r -= lowbit(r))
         res += tree[r];
     return res;
 }
 int main()
 {
     ios::sync_with_stdio(false);
     cin.tie(0);
     int n, m;
     cin >> n >> m;
     for (int i = 1; i <= n; i++)
         cin >> a[i];
     for (int i = 1; i <= n; i++)
         update(a[i] - a[i - 1], i, n);
     while (m--) {
         int op;
         cin >> op;
         if (op == 1) {
             int l, r, k;
             cin >> l >> r >> k;
             update(k, l, n);
             update(-k, r + 1, n);
         } else {
             int x;
             cin >> x;
             cout << sum(x) << '\n';
         }
     }
 }
```

---

æ—¢ç„¶å·²ç»æœ‰äº†å•ç‚¹ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢å’ŒåŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ã€‚

é¦–å…ˆï¼Œæ—¢ç„¶è¦åŒºé—´ä¿®æ”¹ï¼Œé‚£æˆ‘ä»¬æ˜¾ç„¶è¿˜æ˜¯è¦ç”¨å·®åˆ†æ•°ç»„ï¼Œä½†æ˜¯è¦å¦‚ä½•åšåˆ°åŒºé—´æŸ¥è¯¢å‘¢ï¼Ÿå‡å¦‚æˆ‘ä»¬è¦æ±‚$i$çš„å‰ç¼€å’Œï¼Œé‚£ä¹ˆå°±éœ€è¦è®¡ç®—$\sum_{n=1}^i{sum(n)}$çš„å€¼ã€‚å¦‚æœä¸€ä¸ªä¸€ä¸ªçš„è®¡ç®—å¤ªæµªè´¹æ—¶é—´ï¼Œéœ€è¦å¯»æ‰¾ä¸€ç§æ›´ä¸ºé«˜æ•ˆçš„è®¡ç®—æ–¹å¼ã€‚

ä¸éš¾å‘ç°ï¼Œç”¨å·®åˆ†æ•°ç»„æ±‚$i$å‰ç¼€å’Œçš„è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ç”¨åˆ°äº†$i$æ¬¡ï¼ˆæ¯ä¸€ä¸ª$sum(n)$éƒ½åŒ…å«ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œç¬¬äºŒä¸ªå…ƒç´ ç”¨åˆ°äº†$i-1$æ¬¡â€¦â€¦ä»¥æ­¤ç±»æ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„å…¬å¼å¯ä»¥è½¬å˜ä¸ºä¸‹é¢è¿™ä¸ªå…¬å¼\[\sum_{n=1}^i{tree[n]\times(i-n+1)}\]ç¨å¾®å˜å½¢ä¸€ä¸‹ï¼š\[(i+1)\times \sum_{n=1}^i{tree[n]}-\sum_{n=1}^i{tree[n]\times n}\]å‡å¦‚æˆ‘ä»¬è¿˜ç»´æŠ¤äº†å¦ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„$treei[n]=tree[n]\times n$é‚£ä¹ˆè¿™ä¸ªå…¬å¼å°±å¯ä»¥å˜æˆè¿™æ ·\[(i+1)\times\sum_{n=i}^i{tree[n]}-\sum_{n=1}^i{treei[n]}\]ä¹Ÿå°±æ˜¯ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„çš„å‰ç¼€å’Œï¼Œè¿™æ ·å°±æŠŠåŸæœ¬$O(n\times\log{n})$çš„é€é¡¹æ±‚å’Œè½¬å˜ä¸ºäº†$O(\log{n})$çš„æ ‘çŠ¶æ•°ç»„æ±‚å‰ç¼€å’Œï¼Œå¤§å¤§æé«˜äº†é€Ÿåº¦ã€‚åŸºæœ¬ä»£ç å¦‚ä¸‹ï¼šï¼ˆæ‰¾ä¸åˆ°ä¾‹é¢˜â€¦â€¦ï¼‰

```c++
const int N = 1e6;
int tree[N], treei[N];
void update(int x, int i) {
    for(; i <= N; i += lowbit(i)) {
        tree[i] += x;
    }
}
int sum(int tree[], int i) {
    int res = 0;
    for(; i > 0; i -= lowbit(i)) {
        res += tree[i];
    }
    return res;
}
void updatei(int x, int i) {//æ›´æ–°treei
    for(; i <= N; i += lowbit(i)) {
        treei[i] += i * x;  //å…¶å®å°±æ˜¯æŠŠxå˜æˆäº†x*iâ€¦â€¦
    }
}
int query(int l, int r) {   //æ±‚åŒºé—´å’Œ
    int ans = (r + 1) * sum(tree, r) - sum(treei, r);
    ans -= (l - 1 + 1) * sum(tree, l - 1) - sum(treei, l - 1);
    return ans;
}
```

---

é™¤äº†ä¸Šè¿°çš„å„å¼å„æ ·çš„åŒºé—´ä¿®æ”¹æŸ¥è¯¢ä»¥å¤–ï¼Œæ ‘çŠ¶æ•°ç»„è¿˜æœ‰ä¸€ä¸ªè·ŸåŒºé—´æœ‰å…³çš„åŠŸèƒ½â€”â€”ç»´æŠ¤åŒºé—´æœ€å€¼ã€‚
å‡å¦‚æˆ‘ä»¬éœ€è¦ç»´æŠ¤åŒºé—´çš„æœ€å¤§å€¼ï¼Œé‚£ä¹ˆæ­£å¸¸çš„æƒ³æ³•æˆ–è®¸ä¼šæ˜¯æ¯æ¬¡æ›´æ–°çš„æ—¶å€™ç”¨æœ€å¤§å€¼æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¿™æ ·ï¼š

```c++
void update(int x, int i) {
    for(; i <= n; i += lowbit(i)) {
        tree[i] = max(tree[i], x);
    }
}
```

ä½†è¿™æ ·ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªæœ¬æ¥æ˜¯åŒºé—´æœ€å¤§å€¼çš„æ•°è¢«æ›¿æ¢æˆäº†è¾ƒå°çš„æ•°ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ ‘çŠ¶æ•°ç»„æ˜¾ç„¶æ— æ³•æ”¹å˜ã€‚

å¦‚æœæƒ³è¦æŠŠåŸæ•°ç»„çš„å˜åŒ–å®æ—¶çš„åæ˜ åˆ°æ ‘çŠ¶æ•°ç»„ä¸­ï¼Œæœ€ä¸ºç®€å•æš´åŠ›çš„æ–¹æ³•å°±æ˜¯æ¯æ¬¡åŸæ•°ç»„æ”¹å˜çš„æ—¶å€™éƒ½é‡æ–°å»ºä¸€éæ ‘çŠ¶æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æŠŠæ ‘çŠ¶æ•°ç»„æ¸…é›¶ç„¶åé‡æ–°*update*ä¸€éï¼Œè¿™ä¸ªæ–¹æ³•è™½ç„¶æš´åŠ›ï¼Œä½†æ˜¯æœ‰æ•ˆã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šåšä¸€äº›ä¼˜åŒ–ã€‚

é¦–å…ˆï¼Œæ˜¾ç„¶æˆ‘ä»¬å¹¶ä¸éœ€è¦æ¯ä¸€ä¸ªåŒºé—´éƒ½æ¸…é›¶ï¼Œåªéœ€è¦æŠŠåŒ…å«ä¿®æ”¹ä½ç½®çš„åŒºé—´æ¸…é›¶å¹¶é‡æ–°*update*~~åºŸè¯~~ï¼ŒåŒæ—¶ï¼Œç”±äºä¿®æ”¹ä¸å½±å“ä¸åŒ…å«ä¿®æ”¹ä½ç½®çš„åŒºé—´çš„æ­£ç¡®æ€§ï¼Œè¿™è®©æˆ‘ä»¬è‡ªç„¶å¯ä»¥æƒ³åˆ°æ˜¯å¦èƒ½å¤Ÿå°†è¦ä¿®æ”¹çš„åŒºé—´åˆ’æˆå‡ ä¸ªä¸åŒ…å«ä¿®æ”¹ä½ç½®çš„å­åŒºé—´ï¼Œç„¶åç”¨å­åŒºé—´çš„å€¼å»æ›´æ–°ï¼Œè¿™æ ·å°±ä¸éœ€è¦éå†ç„¶åç”¨æ¯ä¸€ä¸ªå€¼å»æ›´æ–°ã€‚

é‚£ä¹ˆï¼Œæ€»ç»“ä¸€ä¸‹ä¼˜åŒ–çš„æ–¹æ¡ˆï¼š

1. åªä¿®æ”¹åŒ…å«ä¿®æ”¹ä½ç½®çš„åŒºé—´ï¼›
2. ç”¨å°åŒºé—´çš„å€¼å»æ›´æ–°å¤§åŒºé—´çš„å€¼ï¼›

æ–¹æ¡ˆä¸€å…¶å®å°±æ˜¯æ ‘çŠ¶æ•°ç»„æ­£å¸¸çš„æ›´æ–°ï¼Œé‡ç‚¹åœ¨äºæ–¹æ¡ˆäºŒã€‚å¦‚ä½•å°†å…¶åˆ’åˆ†ä¸ºå­åŒºé—´å‘¢ï¼Ÿå‡è®¾ç°åœ¨è¦ä¿®æ”¹çš„ä½ç½®*i*ä¸º`1001 0000`ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªè¦ä¿®æ”¹çš„åŒºé—´ä¸º$(1000 0000,1001 0000]$ã€‚æˆ‘ä»¬æ¨¡æ‹Ÿä¸€éæ¸…é›¶å¹¶é‡æ–°*update*çš„è¿‡ç¨‹ï¼Œé¦–å…ˆå…ˆç”¨ä¿®æ”¹è¿‡çš„å€¼æ›´æ–°ä¸€éï¼š

```c++
tree[i] = a[i];
```

é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æŠŠåŒºé—´$(1000 0000,1000 1111]$æ‹†æˆå°åŒºé—´ï¼Œç»“æœå¦‚ä¸‹ï¼š

```text
1000 1111 --- 1000 1110
1000 1110 --- 1000 1100
1000 1100 --- 1000 1000
1000 1000 --- 1000 0000
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦ç”¨çš„å‡ ä¸ªå€¼ä¸º`1000 1111`,`1000 1110`,`1000 1100`,`1000 1000`ã€‚è§„å¾‹åº”è¯¥å¾ˆæ˜æ˜¾äº†ï¼Œåˆ†åˆ«æ˜¯åŸæ•°$-2^0$ã€$-2^1$ã€$\cdots$ã€$-2^k$ï¼Œä¸€ç›´åˆ°$lowbit(i)$ï¼ˆä¸åŒ…å«*lowbit*ï¼‰ã€‚

æ‰€ä»¥ï¼Œåœ¨ç»´æŠ¤åŒºé—´æœ€å€¼çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨åŸæœ¬çš„åŸºç¡€ä¸Šï¼Œç”¨ä¸€ä¸ªæ•°ç»„å­˜å‚¨åŸæ•°ç»„ï¼Œåœ¨æ¯æ¬¡ä¿®æ”¹æ—¶å…ˆä¿®æ”¹åŸæ•°ç»„ï¼Œå†ç”¨åŸæ•°ç»„çš„å€¼å»æ›´æ–°æ ‘çŠ¶æ•°ç»„ï¼Œæœ€åç”¨ä¸€ä¸ªå†…å¾ªç¯ç”¨å°åŒºé—´çš„å€¼å»æ›´æ–°ã€‚ç”±äºå†…å¾ªç¯æ¯æ¬¡éƒ½æ˜¯ä¹˜2ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶å·¦ç§»ä¸€ä½ï¼Œå¤æ‚åº¦ä¸º$\log{n}$ï¼Œæ•…æ€»ä½“å¤æ‚åº¦ä¸º$O((\log{n})^2)$ã€‚

```c++
void update(int x, int i) {
    a[i] = x;
    for(; i <= n; i += lowbit(i)) {
        tree[i] = a[i];
        for(int j = 1; j < lowbit(i); j <<= 1) {
            tree[i] = max(tree[i], tree[i - j]);
        }
    }
}
```

è¯´å®Œäº†ä¿®æ”¹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŸ¥è¯¢äº†ã€‚æŸ¥è¯¢å½“ç„¶ä¹Ÿä¸èƒ½åƒæ™®é€šçš„æ ‘çŠ¶æ•°ç»„é‚£æ ·æŸ¥è¯¢ï¼Œå¦‚æœè¦æŸ¥ä¸­é—´çš„æŸä¸€æ®µåŒºé—´$[x,y]$ï¼Œä¹Ÿä¸èƒ½æ–¹ä¾¿çš„ç›´æ¥$sum(y)-sum(x-1)$~~ç„¯~~ã€‚æˆ‘ä»¬ä¾ç„¶å¯ä»¥é‡‡ç”¨ä¸Šé¢çš„æ€è·¯ï¼ŒæŠŠéœ€è¦æŸ¥è¯¢çš„åŒºé—´æ‹†æˆå‡ ä¸ªå°åŒºé—´ã€‚æ¯”å¦‚è¦æŸ¥è¯¢$[1001 0000,1001 0110]$çš„æœ€å€¼ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªåŒºé—´å°±æ˜¯$(1001 0100,1001 0110]$ã€‚ä½†è¿™æ ·ç›´æ¥æ‹†åˆä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜~~å¥½çƒ¦~~ï¼Œå¦‚æœåŒºé—´æ”¹æˆ$[1001 0101,1001 0110]$ï¼Œé‚£ä¹ˆ`1001 0110`æ‰€ç»´æŠ¤çš„åŒºé—´å°±è¶…è¿‡äº†æŸ¥è¯¢çš„åŒºé—´ï¼Œä¹Ÿå°±æ— æ³•ä¿è¯ç»“æœçš„æ­£ç¡®æ€§ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¦ç¨³ä¸€æ‰‹ï¼Œä¸èƒ½ç›´æ¥æ‹†ã€‚å¦‚ä½•ä¿è¯æ¯æ¬¡æ‹†åŒºé—´æ—¶ä¸è¶Šç•Œå‘¢ï¼Ÿæœ€ç®€å•çš„æ–¹æ³•å½“ç„¶æ˜¯ä¸€æ¬¡åªæ‹†èµ°ä¸€ä¸ª1ï¼Œä½†è¿™æ ·å°±å’Œéå†æ²¡æœ‰åŒºåˆ«äº†ã€‚æˆ‘ä»¬å¸Œæœ›ï¼Œåœ¨èƒ½æ‹†åŒºé—´æ—¶å°±æ‹†æˆåŒºé—´ï¼Œåªæœ‰åœ¨è¿«ä¸å¾—å·²æ—¶æ‰æ‹†èµ°ä¸€ä¸ª1ï¼Œä¹Ÿå°±æ˜¯åœ¨$y-lowbit(y)<x$çš„æ—¶å€™å°±æ‹†èµ°ä¸€ä¸ª1ï¼Œå¦åˆ™å°±æŒ‰æ­£å¸¸çš„åŒºé—´æ‹†åˆ†æ–¹å¼å»æ‹†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```c++
int query(int x, int y) {
    int ans = 0;
    while(x <= y) { //ä¸ºä»€ä¹ˆæ˜¯å°äºç­‰äºå‘¢ï¼Ÿåˆ«å¿˜äº†æ ‘çŠ¶æ•°ç»„çš„åŒºé—´æ˜¯å·¦å¼€å³é—­ï¼Œæ‰€ä»¥æœ€åè¦å•ç‹¬ç”¨a[x]çš„å€¼æ›´æ–°ä¸€éã€‚
        ans = max(ans, a[y]);
        y--;
        for(; y - lowbit(y) >= x; y -= lowbit(y)) {
            ans = max(ans, tree[y]);
        }
    }
    return ans;
}
```

ä¾‹é¢˜[P1440](https://www.luogu.com.cn/problem/P1440)ï¼ˆå…¶å®è¿™é¢˜çš„æ ‡å‡†åšæ³•åº”è¯¥æ˜¯å•è°ƒé˜Ÿåˆ—ï¼Œä½†æˆ‘æ‰¾ä¸åˆ°åˆ«çš„é¢˜äº†â€¦â€¦æ ‘çŠ¶æ•°ç»„äº²æµ‹ä¼štä¸‰ä¸ªç‚¹ï¼Œä½†ä¸ä¼šwaï¼Œå¯ä»¥ç”¨æ¥æ£€éªŒä»£ç æ˜¯å¦æœ‰è¯¯ï¼‰

```c++
 #include <bits/stdc++.h>
 #define lowbit(x) ((x) & -x)
 using namespace std;
 typedef long long ll;
 int n;
 int a[2000010], tree[2000010];
 void update(int x, int i)
 {
     for (; i <= n; i += lowbit(i)) {
         tree[i] = a[i];
         for (int j = 1; j < lowbit(i); j <<= 1) {
             tree[i] = min(tree[i], tree[i - j]);  // ç”¨å­åŒºé—´æ•°æ®æ›´æ–°
         }
     }
 }
 int query(int x, int y)
 {
     int ans = INT_MAX;
     while (y >= x) {
         ans = min(a[y], ans);
         y--;
         for (; y - lowbit(y) >= x; y -= lowbit(y))
             ans = min(tree[y], ans);
     } // æŠŠåŒºé—´xï¼Œyåˆ’åˆ†ä¸ºå°åŒºé—´
     return ans;
 }
 int main()
 {
     ios::sync_with_stdio(false);
     cin.tie(0);
     int m;
     cin >> n >> m;
     for (int i = 1; i <= n; i++) {
         cin >> a[i];
         update(a[i], i);
     }
     cout << 0 << '\n';
     for (int i = 2; i <= n; i++) {
         cout << query(max(1, i - m), i - 1) << '\n';
     }
 }
```

---

æœ€åä¸€ä¸ªç”¨æ³•ï¼ˆæŒ‡æˆ‘ä¼šçš„ï¼Œå…¶ä»–æ›´é«˜çº§çš„ç”¨æ³•è¿˜æ²¡å­¦â€¦â€¦å¤ªèœäº†ğŸ˜­ï¼‰æ˜¯ç»Ÿè®¡é€†åºå¯¹æ•°é‡ï¼Œç›¸æ¯”äºä¸Šé¢å‡ ç§ç”¨æ³•è€Œè¨€ï¼Œç»Ÿè®¡é€†åºå¯¹ä¸éœ€è¦å¯¹æ ‘çŠ¶æ•°ç»„çš„åŸæœ‰æ“ä½œåšä¿®æ”¹ï¼Œè€Œæ˜¯åˆ©ç”¨æ ‘çŠ¶æ•°ç»„å¿«é€Ÿæ±‚å‰ç¼€å’Œçš„ç‰¹ç‚¹ï¼Œå¯¹åŸæœ¬çš„é—®é¢˜è¿›è¡Œäº†å·§å¦™åœ°è½¬æ¢ã€‚

ç»Ÿè®¡é€†åºå¯¹ï¼Œä¸€ç§æ€è·¯æ˜¯æ¯æ¬¡åœ¨æ•°ç»„åæ·»åŠ æ–°æˆå‘˜æ—¶ç»Ÿè®¡å‰é¢æ¯”å®ƒå°çš„æ•°æœ‰å‡ ä¸ªã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ•°ç»„ç»Ÿè®¡æ¯ä¸€ä¸ªæ•°å‡ºç°çš„æ¬¡æ•°ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨æ¯ä¸€æ¬¡æ·»åŠ æ–°æˆå‘˜æ—¶ç»Ÿè®¡å‰ç¼€å’Œï¼Œå°±å¯ä»¥ç®—å‡ºæ€»å…±æœ‰å¤šå°‘é€†åºå¯¹ã€‚åŒæ—¶ï¼Œç”±äºæ­¤æ–¹æ³•ä¸å…³å¿ƒæ•°æ®çš„å…·ä½“å¤§å°è€Œåªå…³å¿ƒæ•°æ®ä¹‹é—´çš„å¤§å°å…³ç³»ï¼Œæ‰€ä»¥å¯ä»¥é‡‡ç”¨ç¦»æ•£åŒ–æ¥å‡å°å†…å­˜å¼€æ”¯ã€‚

ä¾‹é¢˜[P1908](https://www.luogu.com.cn/problem/P1908)

```c++
#include <bits/stdc++.h>
#define lowbit(x) ((x) & -x)
using namespace std;
typedef long long ll;
int a[500010], b[500010], tree[500010], n, m;
void update(int i)
{
    for (; i < m; i += lowbit(i))
        tree[i]++;
}
ll sum(int i)
{
    ll res = 0;
    for (; i > 0; i -= lowbit(i))
        res += tree[i];
    return res;
}
int bs(int x, int l, int r)
{
    while (l <= r) {
        int mid = (l + r) >> 1;
        if (x > b[mid])
            l = mid + 1;
        else if (x < b[mid])
            r = mid - 1;
        else
            return mid;
    }
}
int main()
{
    ios::sync_with_stdio(false);
    cin.tie(0);
    cin >> n;
    for (int i = 0; i < n; i++) {
        cin >> a[i];
        b[i] = a[i];
    }
    sort(b, b + n);
    m = unique(b, b + n) - b;
    for (int i = 0; i < n; i++) {
        a[i] = bs(a[i], 0, m - 1) + 1;
    }
    ll ans = 0;
    for (int i = n - 1; i >= 0; i--) {
        update(a[i]);
        ans += sum(a[i] - 1);
    }
    cout << ans << endl;
}
```

---

## ç»“å°¾

ç»ˆäºè‚å®Œäº†â€¦â€¦ğŸ˜µæ•²äº†ä¸¤å¤©ï¼Œç´¯æ­»æˆ‘äº†â€¦â€¦

---

![img](./æ ‘çŠ¶æ•°ç»„æ€»ç»“/1691338926147.png "å¸Œå„¿å¤©ä¸‹ç¬¬ä¸€ï¼ï¼ï¼")
